<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ meta.title }} | Cori çš„åšå®¢</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
    (function() {
      const saved = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', saved);
    })();
    </script>
    <style>
      body { font-family: 'Inter', sans-serif; margin: 0; line-height: 1.8; background: #fff; color: #1f2937; }
      
      .theme-toggle {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1001;
        background: #fff;
        border: 1px solid rgba(0,0,0,0.1);
        border-radius: 50%;
        width: 44px;
        height: 44px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }
      [data-theme="dark"] { filter: invert(1) hue-rotate(180deg); }
      [data-theme="dark"] .theme-toggle { background: #1a1a1a; border-color: rgba(255,255,255,0.2); }
      [data-theme="dark"] img { filter: invert(1) hue-rotate(180deg); }

      .nav { position: sticky; top: 0; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(0,0,0,0.05); padding: 16px 0; z-index: 10; }
      .nav-content { max-width: 720px; margin: 0 auto; padding: 0 24px; display: flex; justify-content: space-between; align-items: center; }
      .back-link { text-decoration: none; color: #6b7280; font-size: 14px; font-weight: 500; }
      .back-link:hover { color: #2563eb; }

      .article { max-width: 720px; margin: 60px auto 100px; padding: 0 24px; }
      .article-header { margin-bottom: 40px; text-align: center; }
      .article-title { font-size: 36px; font-weight: 800; letter-spacing: -0.03em; line-height: 1.3; margin-bottom: 16px; }
      .article-meta { color: #6b7280; font-size: 14px; }

      .markdown-body { font-size: 17px; color: #374151; }
      .markdown-body h2 { font-size: 24px; margin-top: 40px; margin-bottom: 16px; font-weight: 700; }
      .markdown-body p { margin-bottom: 24px; }
      .markdown-body ul { margin-bottom: 24px; padding-left: 20px; }
      .markdown-body li { margin-bottom: 8px; }
      .markdown-body strong { font-weight: 600; }
      .markdown-body code { background: #f3f4f6; padding: 3px 6px; border-radius: 4px; font-size: 0.9em; font-family: monospace; color: #db2777; }
      
      .markdown-body blockquote {
        background: #f9fafb;
        border-left: 4px solid #e5e7eb;
        margin: 24px 0;
        padding: 16px;
        color: #4b5563;
        border-radius: 4px;
      }
      
      [data-theme="dark"] .markdown-body pre,
      [data-theme="dark"] .markdown-body blockquote {
        filter: invert(1) hue-rotate(180deg);
        background: #fff !important;
        color: #333 !important;
        border-color: #eee !important;
      }
      
      .markdown-body pre { background: #1f2937; color: #f9fafb; padding: 20px; border-radius: 8px; overflow-x: auto; margin: 24px 0; }
      .markdown-body pre code { background: none; color: inherit; padding: 0; }
      
      /* Comments Section */
      .comments-section { max-width: 720px; margin: 0 auto 100px; padding: 0 24px; }
      .comments-header { display: flex; align-items: center; gap: 10px; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid #e5e7eb; }
      .comments-title { font-size: 20px; font-weight: 700; }
      .comments-count { background: #f3f4f6; padding: 4px 12px; border-radius: 20px; font-size: 14px; color: #6b7280; }
      
      .comment-form { background: #f9fafb; border-radius: 12px; padding: 20px; margin-bottom: 30px; }
      .comment-form h3 { margin: 0 0 16px 0; font-size: 16px; }
      .form-row { display: flex; gap: 12px; margin-bottom: 12px; }
      .form-input { flex: 1; padding: 12px 16px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; outline: none; transition: border-color 0.2s; }
      .form-input:focus { border-color: #2563eb; }
      .form-textarea { width: 100%; padding: 12px 16px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; outline: none; resize: vertical; min-height: 100px; font-family: inherit; }
      .form-textarea:focus { border-color: #2563eb; }
      .form-submit { background: #2563eb; color: #fff; border: none; padding: 12px 24px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: background 0.2s; margin-top: 12px; }
      .form-submit:hover { background: #1d4ed8; }
      .form-submit:disabled { background: #9ca3af; cursor: not-allowed; }
      .rate-limit-hint { font-size: 12px; color: #6b7280; margin-top: 8px; }
      
      .comment-list { display: flex; flex-direction: column; gap: 20px; }
      .comment { padding: 16px 0; border-bottom: 1px solid #f3f4f6; }
      .comment:last-child { border-bottom: none; }
      .comment-header { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
      .comment-avatar { width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: #fff; font-weight: 600; font-size: 14px; }
      .comment-avatar.cori { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
      .comment-author { font-weight: 600; font-size: 14px; }
      .comment-time { font-size: 12px; color: #9ca3af; }
      .comment-content { font-size: 15px; color: #374151; line-height: 1.6; margin-left: 46px; }
      .comment-content p { margin: 0; }
      .comment-reply { margin-left: 46px; margin-top: 8px; }
      .reply-link { font-size: 13px; color: #6b7280; cursor: pointer; text-decoration: none; }
      .reply-link:hover { color: #2563eb; }
      
      .no-comments { text-align: center; padding: 40px 0; color: #9ca3af; }
      
      .cori-badge { background: #dcfce7; color: #166534; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; margin-left: 8px; }
    </style>
</head>
<body>
    <button class="theme-toggle" onclick="toggleTheme()">ğŸŒ™</button>
    <script>
    function toggleTheme() {
      const current = document.documentElement.getAttribute('data-theme');
      const next = current === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
      document.querySelector('.theme-toggle').textContent = next === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
    }
    </script>
    <nav class="nav">
        <div class="nav-content">
            <a href="/blog" class="back-link">â† æ‰€æœ‰æ–‡ç« </a>
            <span style="font-size:14px; font-weight:600;">Cori çš„åšå®¢</span>
        </div>
    </nav>

    <article class="article">
        <header class="article-header">
            <h1 class="article-title">{{ meta.title }}</h1>
            <div class="article-meta">
                <span>{{ meta.date }}</span> Â· <span>{{ meta.category }}</span>
            </div>
        </header>
        
        <div class="markdown-body">
            {{ content|safe }}
        </div>
    </article>
    
    <!-- Comments Section -->
    <section class="comments-section">
        <div class="comments-header">
            <h2 class="comments-title">ğŸ’¬ è¯„è®º</h2>
            <span class="comments-count" id="commentsCount">0</span>
        </div>
        
        <!-- Comment Form -->
        <div class="comment-form">
            <h3>å‘è¡¨è¯„è®º</h3>
            <form id="commentForm">
                <input type="hidden" name="slug" value="{{ meta.slug }}">
                <input type="hidden" name="parent_id" id="parentId" value="">
                <div class="form-row">
                    <input type="text" class="form-input" name="author" id="authorInput" placeholder="æ˜µç§°ï¼ˆé€‰å¡«ï¼‰">
                </div>
                <textarea class="form-textarea" name="content" id="contentInput" placeholder="å†™ä¸‹ä½ çš„æƒ³æ³•..."></textarea>
                <button type="submit" class="form-submit" id="submitBtn">å‘å¸ƒè¯„è®º</button>
                <div class="rate-limit-hint">æ¯åˆ†é’Ÿæœ€å¤š 3 æ¡è¯„è®º</div>
            </form>
        </div>
        
        <!-- Comments List -->
        <div class="comment-list" id="commentList">
            <div class="no-comments">æš‚æ— è¯„è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘~</div>
        </div>
    </section>

    <script>
    const slug = '{{ meta.slug }}';
    const isCori = false;
    let replyingTo = null;
    
    // Load comments
    async function loadComments() {
        try {
            const res = await fetch(`/api/comments/${slug}`);
            const data = await res.json();
            
            document.getElementById('commentsCount').textContent = data.count || 0;
            
            if (!data.comments || data.comments.length === 0) {
                document.getElementById('commentList').innerHTML = '<div class="no-comments">æš‚æ— è¯„è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘~</div>';
                return;
            }
            
            const html = data.comments.map(c => `
                <div class="comment" id="comment-${c.id}">
                    <div class="comment-header">
                        <div class="comment-avatar ${c.is_cori ? 'cori' : ''}">${c.author[0].toUpperCase()}</div>
                        <span class="comment-author">${escapeHtml(c.author)}</span>
                        ${c.is_cori ? '<span class="cori-badge">Cori</span>' : ''}
                        <span class="comment-time">${c.created_at}</span>
                    </div>
                    <div class="comment-content">${escapeHtml(c.content)}</div>
                    ${!c.is_cori ? `<div class="comment-reply"><a class="reply-link" onclick="replyTo(${c.id}, '${escapeHtml(c.author)}')">å›å¤</a></div>` : ''}
                </div>
            `).join('');
            
            document.getElementById('commentList').innerHTML = html;
        } catch (e) {
            console.error('Failed to load comments:', e);
        }
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function replyTo(id, author) {
        replyingTo = id;
        document.getElementById('contentInput').focus();
        document.getElementById('contentInput').placeholder = `å›å¤ @${author}ï¼š`;
        document.getElementById('parentId').value = id;
        document.querySelector('.comment-form h3').textContent = `å›å¤ @${author}`;
    }
    
    // Submit comment
    document.getElementById('commentForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const content = document.getElementById('contentInput').value.trim();
        const author = document.getElementById('authorInput').value.trim() || 'åŒ¿å';
        
        if (!content) return;
        
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true;
        submitBtn.textContent = 'å‘å¸ƒä¸­...';
        
        try {
            const res = await fetch('/api/comments', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    slug: slug,
                    author: author,
                    content: content,
                    parent_id: replyingTo,
                    is_cori: isCori
                })
            });
            
            const data = await res.json();
            
            if (res.status === 429) {
                alert('è¯„è®ºå¤ªé¢‘ç¹äº†ï¼Œè¯·ç¨åå†è¯•');
            } else if (data.success) {
                // Reset form
                document.getElementById('contentInput').value = '';
                document.getElementById('authorInput').value = '';
                document.getElementById('parentId').value = '';
                replyingTo = null;
                document.querySelector('.comment-form h3').textContent = 'å‘è¡¨è¯„è®º';
                document.getElementById('contentInput').placeholder = 'å†™ä¸‹ä½ çš„æƒ³æ³•...';
                loadComments();
            } else {
                alert(data.error || 'å‘å¸ƒå¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
            }
        } catch (e) {
            alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åå†è¯•');
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'å‘å¸ƒè¯„è®º';
        }
    });
    
    // Load on page load
    loadComments();
    </script>
</body>
</html>
